<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Browse All Parts - PC Parts Tracker</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b0f17; color:#e8eefc; }
    nav { padding: 1rem 16px; border-bottom: 1px solid rgba(255,255,255,.08); background: #0b0f17; position: sticky; top: 0; z-index: 100; }
    .nav-container { max-width: 1200px; margin: 0 auto; display: flex; gap: 2rem; align-items: center; }
    .nav-container a { color: #e8eefc; text-decoration: none; font-weight: 600; }
    .nav-container a:hover { color: #3b82f6; }
    .nav-separator { opacity: 0.5; }
    header { padding: 18px 16px; }
    h1 { margin:0; font-size: 18px; letter-spacing:.2px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    select, input { background:#101828; color:#e8eefc; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px; outline:none; }
    input { min-width: 220px; }
    main { padding: 16px; max-width: 1200px; margin: 0 auto; }
    .meta { opacity:.8; font-size: 13px; margin: 10px 0 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:14px; margin-top: 14px; }
    .card { background:#0f172a; border:1px solid rgba(255,255,255,.08); border-radius:16px; overflow:hidden; box-shadow: 0 10px 25px rgba(0,0,0,.25); display:flex; flex-direction:column; }
    .thumb { width:100%; aspect-ratio: 16 / 10; background:#0b1220; display:block; object-fit: cover; }
    .content { padding: 12px 12px 14px; display:flex; flex-direction:column; gap:8px; }
    .title { font-size: 14px; line-height: 1.25; margin:0; }
    .subtitle { font-size: 12px; opacity:.75; line-height: 1.25; margin:0; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; background: rgba(59,130,246,.18); border: 1px solid rgba(59,130,246,.25); }
    .price { font-weight: 800; }
    .site-badge { font-size: 11px; padding: 3px 7px; border-radius: 999px; background: rgba(16,185,129,.18); border: 1px solid rgba(16,185,129,.25); }
    a.btn { margin-top:6px; display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px; border-radius:12px; background: rgba(16,185,129,.18); border:1px solid rgba(16,185,129,.28); color:#dffbee; text-decoration:none; }
    a.btn:hover { filter: brightness(1.08); }
    .error { color:#ffb4b4; }
    .toggle { display:flex; gap:8px; align-items:center; user-select:none; }
    .toggle input { min-width: auto; }
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <a href="index.html">← Home</a>
      <span class="nav-separator">|</span>
      <span style="font-weight: 600;">Browse All Parts</span>
    </div>
  </nav>
  <header>
    <h1>PC Parts Tracker - Browse All</h1>
    <div class="controls">
      <select id="partType">
        <option value="ALL">All Part Types</option>
        <option value="gpu">GPU</option>
        <option value="cpu">CPU</option>
        <option value="motherboard">Motherboard</option>
        <option value="psu">PSU</option>
        <option value="case">Case</option>
        <option value="ssd">SSD</option>
        <option value="keyboard">Keyboard</option>
        <option value="mouse">Mouse</option>
        <option value="monitor">Monitor</option>
        <option value="headsets">Headsets</option>
        <option value="prebuilts">Prebuilts</option>
        <option value="cables">Cables</option>
      </select>
      <input id="search" type="text" placeholder="Search name / keyword..." />
      <select id="site">
        <option value="ALL">All Sites</option>
        <option value="ebay">eBay</option>
        <option value="newegg">Newegg</option>
      </select>
      <select id="condition">
        <option value="ALL">All Conditions</option>
        <option value="New">New</option>
        <option value="Used">Used</option>
        <option value="Open Box">Open Box</option>
      </select>
      <select id="sort">
        <option value="price-asc">Price: Low → High</option>
        <option value="price-desc">Price: High → Low</option>
        <option value="title-asc">Name: A → Z</option>
      </select>
    </div>
    <div class="meta">
      <span id="meta">Loading…</span>
      <label class="toggle">
        <input id="showRaw" type="checkbox" checked />
        <span>Show raw titles</span>
      </label>
    </div>
  </header>
  <main>
    <div id="error" class="error"></div>
    <div class="grid" id="grid"></div>
  </main>
  <script>
    const DATA_FILES = ["data/gpu.json","data/cpu.json","data/motherboard.json","data/psu.json","data/case.json","data/ssd.json","data/keyboard.json","data/mouse.json","data/monitor.json","data/headsets.json","data/prebuilts.json","data/cables.json"];
    
    const FALLBACK_IMG = "data:image/svg+xml;charset=utf-8," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="750"><rect width="100%" height="100%" fill="#0b1220"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="42" fill="#7aa2ff">No Image</text></svg>');
    
    function upgradeEbayImg(url) {
      if (!url) return "";
      return String(url).trim().replace(/\/s-l\d+\.(jpg|jpeg|png|webp)$/i, "/s-l1600.$1");
    }
    
    const BRAND_MAP = [["msi","MSI"],["asus","ASUS"],["gigabyte","Gigabyte"],["evga","EVGA"],["zotac","Zotac"],["pny","PNY"],["corsair","Corsair"],["crucial","Crucial"],["samsung","Samsung"]];
    
    function getBrand(textLower) {
      for (const [needle, brand] of BRAND_MAP) {
        if (textLower.includes(needle)) return brand;
      }
      return "";
    }
    
    function pickMatch(textLower, regex) {
      const m = textLower.match(regex);
      return m ? m[0] : "";
    }
    
    function normalizeName(part) {
      const rawTitle = String(part.title || part.name || "").trim();
      if (!rawTitle) return "Unknown Item";
      let t = rawTitle.toLowerCase();
      const junk = [/opens in a new window or tab/gi, /\bfree shipping\b/gi, /\bnew listing\b/gi];
      junk.forEach(rx => t = t.replace(rx, " "));
      t = t.replace(/\s+/g, " ").trim();
      const pt = (part.partType || "").trim();
      const brand = getBrand(t);
      if (pt === "gpu") {
        const modelRaw = pickMatch(t, /\b(rtx|gtx|rx)\s?-?\s?\d{3,4}\s?(ti|super|xtx|xt)?\b/i);
        const model = modelRaw ? modelRaw.toUpperCase().replace(/\s+/g, " ").trim() : "";
        const vramRaw = pickMatch(t, /\b(\d+)\s?gb\b/i);
        const vram = vramRaw ? vramRaw.toUpperCase().replace(" ", "") : "";
        return [model, brand, vram].filter(Boolean).join(" · ") || rawTitle;
      }
      if (pt === "cpu") {
        const ryzen = pickMatch(t, /\bryzen\s[3579]\s?\d{4,5}\b|\bi[3579]\s?-?\s?\d{4,5}[a-z]*\b/i);
        const cpuName = ryzen ? ryzen.toUpperCase().replace(/\s+/g, " ").trim() : "";
        return [cpuName || rawTitle].filter(Boolean).join(" · ");
      }
      return rawTitle;
    }
    
    function normalizedCondition(part) {
      const raw = String(part.condition || "").trim();
      const text = `${part.title || ""} ${part.name || ""}`.toLowerCase();
      if (text.includes("open box")) return "Open Box";
      if (text.includes("used")) return "Used";
      return raw || "Unknown";
    }
    
    const state = {all: [], partType: "ALL", site: "ALL", condition: "ALL", sort: "price-asc", search: "", showRaw: true};
    
    function money(n) {
      return typeof n !== "number" ? "" : "$" + n.toFixed(2);
    }
    
    async function loadAllParts() {
      const lists = [];
      for (const file of DATA_FILES) {
        try {
          const res = await fetch(file, {cache: "no-store"});
          if (!res.ok) throw new Error(`${file} → ${res.status}`);
          const data = await res.json();
          if (Array.isArray(data)) lists.push(...data);
        } catch (e) {
          console.warn("Failed to load:", file, e);
        }
      }
      return lists.map(p => ({...p, _cond: normalizedCondition(p), _displayName: normalizeName(p)}));
    }
    
    function applyFilters(items) {
      const q = state.search.trim().toLowerCase();
      let out = items.filter(p => {
        if (state.partType !== "ALL" && p.partType !== state.partType) return false;
        if (state.site !== "ALL" && (p.site || "").toLowerCase() !== state.site.toLowerCase()) return false;
        if (state.condition !== "ALL" && (p._cond || "Unknown") !== state.condition) return false;
        if (q) {
          const hay = `${p._displayName || ""} ${p.title || ""} ${p.keyword || ""}`.toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });
      if (state.sort === "price-asc") out.sort((a,b) => (a.price ?? 1e12) - (b.price ?? 1e12));
      if (state.sort === "price-desc") out.sort((a,b) => (b.price ?? -1) - (a.price ?? -1));
      if (state.sort === "title-asc") out.sort((a,b) => String(a._displayName||"").localeCompare(String(b._displayName||"")));
      return out;
    }
    
    function card(part) {
      const rawImg = part.image_url && String(part.image_url).trim() ? part.image_url : "";
      const upgraded = rawImg ? upgradeEbayImg(rawImg) : "";
      const imgSrc = upgraded || FALLBACK_IMG;
      const el = document.createElement("div");
      el.className = "card";
      const img = document.createElement("img");
      img.className = "thumb";
      img.loading = "lazy";
      img.src = imgSrc;
      img.onerror = () => {
        if (rawImg && img.src !== rawImg) {
          img.src = rawImg;
          img.onerror = () => { img.src = FALLBACK_IMG; };
        } else {
          img.src = FALLBACK_IMG;
        }
      };
      const content = document.createElement("div");
      content.className = "content";
      const title = document.createElement("p");
      title.className = "title";
      title.textContent = part._displayName || part.title || part.name || "Untitled";
      const sub = document.createElement("p");
      sub.className = "subtitle";
      sub.textContent = state.showRaw ? (part.title || part.name || "") : "";
      const row = document.createElement("div");
      row.className = "row";
      const price = document.createElement("span");
      price.className = "price";
      price.textContent = money(part.price);
      const pill1 = document.createElement("span");
      pill1.className = "pill";
      pill1.textContent = part.partType || "Unknown";
      const pill2 = document.createElement("span");
      pill2.className = "pill";
      pill2.textContent = part._cond || "Unknown";
      const siteBadge = document.createElement("span");
      siteBadge.className = "site-badge";
      siteBadge.textContent = (part.site || "unknown").toUpperCase();
      row.appendChild(price);
      row.appendChild(siteBadge);
      row.appendChild(pill1);
      row.appendChild(pill2);
      const btn = document.createElement("a");
      btn.className = "btn";
      btn.href = part.url || "#";
      btn.target = "_blank";
      btn.rel = "noopener noreferrer";
      btn.textContent = "Open Listing";
      content.appendChild(title);
      if (state.showRaw) content.appendChild(sub);
      content.appendChild(row);
      content.appendChild(btn);
      el.appendChild(img);
      el.appendChild(content);
      return el;
    }
    
    function render() {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      const filtered = applyFilters(state.all);
      for (const p of filtered) grid.appendChild(card(p));
      document.getElementById("meta").textContent = `${filtered.length.toLocaleString()} shown • ${state.all.length.toLocaleString()} total`;
    }
    
    function wireControls() {
      document.getElementById("partType").addEventListener("change", (e) => { state.partType = e.target.value; render(); });
      document.getElementById("site").addEventListener("change", (e) => { state.site = e.target.value; render(); });
      document.getElementById("condition").addEventListener("change", (e) => { state.condition = e.target.value; render(); });
      document.getElementById("sort").addEventListener("change", (e) => { state.sort = e.target.value; render(); });
      document.getElementById("search").addEventListener("input", (e) => { state.search = e.target.value; render(); });
      document.getElementById("showRaw").addEventListener("change", (e) => { state.showRaw = !!e.target.checked; render(); });
    }
    
    (async function init() {
      wireControls();
      document.getElementById("error").textContent = "";
      const parts = await loadAllParts();
      state.all = parts;
      if (!parts.length) {
        document.getElementById("error").textContent = "No parts loaded. Check that data/*.json files exist.";
      }
      render();
    })();
  </script>
</body>
</html>